# Banking Demo with Temporal.io

Sistema banc√°rio completo demonstrando o uso do Temporal.io para orquestra√ß√£o de transfer√™ncias monet√°rias com arquitetura de microservi√ßos, implementando padr√µes de saga distribu√≠da, CDC (Change Data Capture) e auditoria completa em tempo real.

## üèóÔ∏è Arquitetura do Sistema

### Microservi√ßos

| Servi√ßo | Porta | Responsabilidade | Tecnologias |
|---------|-------|------------------|-------------|
| **Account Service** | 8081 | Gerenciamento de contas banc√°rias, opera√ß√µes de saldo e persist√™ncia | Spring Boot, JPA, PostgreSQL |
| **Transfer Service** | 8082 | Orquestra√ß√£o de transfer√™ncias usando workflows Temporal, coordena√ß√£o de saga | Temporal SDK, Spring Boot, Kafka |
| **Validation Service** | 8087 | Valida√ß√£o de transfer√™ncias, detec√ß√£o de fraudes e regras de neg√≥cio | Spring Boot, OpenFeign |
| **Notification Service** | 8086 | Notifica√ß√µes de status via eventos Kafka, comunica√ß√£o ass√≠ncrona | Spring Kafka, Spring Boot |
| **Audit Service** | 8085 | Trilha de auditoria completa via CDC, rastreabilidade de eventos | Debezium, Kafka Consumer, PostgreSQL |

### Infraestrutura

| Componente | Porta | Descri√ß√£o | Configura√ß√£o |
|------------|-------|-----------|--------------|
| **PostgreSQL (Main)** | 5432 | Banco principal (banking_demo) com WAL habilitado | Logical replication, publica√ß√µes CDC |
| **PostgreSQL (Audit)** | 5433 | Banco de auditoria (audit_db) para eventos | Armazenamento JSONB otimizado |
| **Temporal Server** | 7233 | Motor de workflows distribu√≠dos | OpenSearch backend, namespace padr√£o |
| **Temporal UI** | 8088 | Interface web do Temporal para monitoramento | Dashboard de workflows e execu√ß√µes |
| **Kafka** | 9092 | Message broker para eventos CDC e notifica√ß√µes | Configura√ß√£o single-node |
| **Kafka UI** | 8090 | Interface web do Kafka para debug | Visualiza√ß√£o de t√≥picos e mensagens |
| **Debezium Connect** | 8083 | CDC connector para captura de mudan√ßas | Conector PostgreSQL configurado |
| **Zookeeper** | 2181 | Coordena√ß√£o do cluster Kafka | Configura√ß√£o b√°sica |
| **OpenSearch** | 9200 | Backend de persist√™ncia para Temporal | Substituindo Elasticsearch |

## üöÄ Instala√ß√£o e Configura√ß√£o

### Pr√©-requisitos

- **Java 21+** (testado com OpenJDK 21)
- **Maven 3.8+** (ou usar ./mvnw inclu√≠do)
- **Docker & Docker Compose** (vers√£o 20.10+)
- **Git**
- **Make** (opcional, mas altamente recomendado)
- **curl** e **jq** (para scripts de teste)

### ‚ö° Setup R√°pido com Makefile

```bash
# Clone o reposit√≥rio
git clone <repository-url>
cd banking-demo

# Setup completo em um comando (primeira vez)
make setup

# Para desenvolvimento ativo (inicia todos os servi√ßos)
make -f Makefile.dev dev-setup
make -f Makefile.dev dev-start

# Verificar se tudo est√° funcionando
make debug-all
```

### üéØ Setup Alternativo para Desenvolvimento

```bash
# Setup completo com reinicializa√ß√£o e teste
make -f Makefile.dev dev-restart-all

# Ou setup manual passo a passo
make setup-infra          # Infraestrutura Docker
make setup-cdc            # Configura√ß√£o CDC
make build-all            # Compila√ß√£o
make -f Makefile.dev dev-start  # Iniciar servi√ßos
```

### üìã Comandos Principais

```bash
# Ver todos os comandos dispon√≠veis
make help

# üì¶ Setup e Inicializa√ß√£o
make setup              # Setup completo (primeira vez)
make setup-infra        # Apenas infraestrutura Docker
make setup-cdc          # Apenas configura√ß√£o CDC
make check-infra        # Verificar infraestrutura

# üî® Build e Execu√ß√£o
make build-all          # Compila todos os servi√ßos
make build-service SERVICE=account-service  # Compila servi√ßo espec√≠fico
make run-service SERVICE=account-service    # Executa um servi√ßo

# üß™ Testes
make test-all           # Todos os testes unit√°rios
make test-transfer      # Teste de transfer√™ncia end-to-end
make test-cdc           # Teste do CDC completo
make test-cdc-data      # Teste com dados espec√≠ficos

# üîç Debug e Diagn√≥stico
make debug-all          # Diagn√≥stico completo do sistema
make debug-cdc          # Debug espec√≠fico do CDC
make debug-temporal     # Debug do Temporal
make debug-services     # Status dos microservi√ßos
make debug-kafka-live   # Monitor Kafka em tempo real

# üõ†Ô∏è Corre√ß√µes e Reset
make restart-all        # Reinicia toda infraestrutura
make reset-cdc          # Reset completo do CDC
make reset-temporal     # Reset workflows Temporal
make reset-audit-consumer  # Reset consumer de auditoria
make fix-audit-db       # Corrige tabela de auditoria

# üßπ Limpeza
make clean              # Limpeza completa
make stop               # Para todos os servi√ßos
make stop-services      # Para apenas microservi√ßos
make force-clean        # Limpeza for√ßada (cuidado!)

# üåê Utilit√°rios
make urls               # Mostra URLs √∫teis
make check-orphans      # Verifica containers √≥rf√£os
```

### üõ†Ô∏è Desenvolvimento com Makefile.dev

```bash
# üöÄ Setup e Controle de Servi√ßos
make -f Makefile.dev dev-setup           # Setup de desenvolvimento
make -f Makefile.dev dev-restart-all     # Reinicializa√ß√£o completa
make -f Makefile.dev dev-start           # Inicia todos em background
make -f Makefile.dev dev-stop            # Para todos os servi√ßos
make -f Makefile.dev dev-restart SERVICE=account-service  # Reinicia espec√≠fico

# üìã Logs e Monitoramento
make -f Makefile.dev dev-logs SERVICE=account-service     # Logs espec√≠ficos
make -f Makefile.dev dev-logs-all        # Logs de todos
make -f Makefile.dev dev-tail-logs       # Acompanha logs em tempo real
make -f Makefile.dev dev-health-check    # Verifica√ß√£o de sa√∫de completa
make -f Makefile.dev dev-check-errors    # Procura erros nos logs

# üß™ Testes de Desenvolvimento
make -f Makefile.dev dev-test-flow       # Teste completo do fluxo
make -f Makefile.dev dev-test-cdc-only   # Teste apenas CDC
make -f Makefile.dev dev-test-temporal   # Teste apenas Temporal

# üîç Debug Avan√ßado
make -f Makefile.dev dev-debug-kafka     # Monitor Kafka em tempo real
make -f Makefile.dev dev-debug-db        # Consulta dados dos bancos

# üßπ Utilit√°rios
make -f Makefile.dev dev-clean-logs      # Limpa logs
make -f Makefile.dev dev-reset-data      # Remove dados de teste
```

> üí° **Dica**: Use `make -f Makefile.dev dev-restart-all` para um ambiente completamente limpo e funcional.

### üîß Setup Manual (sem Makefile)

<details>
<summary>Clique para ver instru√ß√µes manuais</summary>

#### 1. Inicie a Infraestrutura

```bash
docker-compose -f docker-compose.yml up -d
```

#### 2. Configure o CDC

```bash
# Aguarde 30 segundos para os servi√ßos iniciarem
sleep 30

# Configure publica√ß√£o PostgreSQL
docker exec banking-postgres psql -U postgres -d banking_demo -c "
CREATE PUBLICATION dbz_publication FOR TABLE public.accounts, public.transfers;"

# Registre conector Debezium
curl -X POST http://localhost:8083/connectors -H "Content-Type: application/json" -d '{
  "name": "banking-connector",
  "config": {
    "connector.class": "io.debezium.connector.postgresql.PostgresConnector",
    "database.hostname": "postgres",
    "database.port": "5432",
    "database.user": "postgres",
    "database.password": "postgres",
    "database.dbname": "banking_demo",
    "topic.prefix": "banking",
    "table.include.list": "public.accounts,public.transfers",
    "plugin.name": "pgoutput",
    "publication.name": "dbz_publication",
    "slot.name": "dbz_slot",
    "key.converter": "org.apache.kafka.connect.json.JsonConverter",
    "value.converter": "org.apache.kafka.connect.json.JsonConverter",
    "key.converter.schemas.enable": "false",
    "value.converter.schemas.enable": "false",
    "snapshot.mode": "initial"
  }
}'
```

#### 3. Compile e Execute

```bash
# Compile
./mvnw clean package -DskipTests

# Execute cada servi√ßo em terminal separado
java -jar account-service/target/account-service-1.0-SNAPSHOT.jar
java -jar transfer-service/target/transfer-service-1.0-SNAPSHOT.jar
java -jar validation-service/target/validation-service-1.0-SNAPSHOT.jar
java -jar notification-service/target/notification-service-1.0-SNAPSHOT.jar
java -jar audit-service/target/audit-service-1.0-SNAPSHOT.jar
```

</details>

## üîß Verifica√ß√£o da Instala√ß√£o

### Verificar Servi√ßos

```bash
# Diagn√≥stico completo do CDC
./scripts/diagnose-cdc.sh

# Teste completo do sistema
./scripts/test-audit-cdc.sh
```

### Health Checks

```bash
# Verificar todos os servi√ßos
curl http://localhost:8081/actuator/health  # Account Service
curl http://localhost:8082/actuator/health  # Transfer Service
curl http://localhost:8087/actuator/health  # Validation Service
curl http://localhost:8086/actuator/health  # Notification Service
curl http://localhost:8085/actuator/health  # Audit Service
```

### Interfaces Web

- **Temporal UI**: http://localhost:8088
- **Kafka UI**: http://localhost:8090

## üìã Uso da API

### 1. Criar Contas

```bash
# Conta origem
curl -X POST http://localhost:8081/api/accounts \
  -H "Content-Type: application/json" \
  -d '{
    "accountNumber": "123456",
    "ownerName": "Jo√£o Silva",
    "balance": 1000.00,
    "currency": "BRL"
  }'

# Conta destino
curl -X POST http://localhost:8081/api/accounts \
  -H "Content-Type: application/json" \
  -d '{
    "accountNumber": "789012",
    "ownerName": "Maria Santos",
    "balance": 500.00,
    "currency": "BRL"
  }'

# Consultar conta
curl http://localhost:8081/api/accounts/123456
```

### 2. Realizar Transfer√™ncia

```bash
# Transfer√™ncia b√°sica
curl -X POST http://localhost:8082/api/transfers \
  -H "Content-Type: application/json" \
  -d '{
    "sourceAccountNumber": "123456",
    "destinationAccountNumber": "789012",
    "amount": 100.00,
    "currency": "BRL"
  }'

# Resposta esperada:
# {
#   "workflowId": "transfer-123",
#   "transferId": 123,
#   "status": "INITIATED",
#   "message": "Transfer initiated successfully"
# }
```

### 3. Consultar Status da Transfer√™ncia

```bash
# Por workflow ID (recomendado)
curl http://localhost:8082/api/transfers/workflow/transfer-123

# Por transfer ID
curl http://localhost:8082/api/transfers/123/status

# Por transfer ID direto
curl http://localhost:8082/api/transfers/transfer/123

# Transfer√™ncias por conta
curl http://localhost:8082/api/transfers/account/123456
```

### 4. Consultar Trilha de Auditoria

```bash
# Auditoria de uma conta espec√≠fica
curl http://localhost:8085/api/audit/accounts/123456

# Busca por tipo de evento e per√≠odo
curl "http://localhost:8085/api/audit/search?entityType=accounts&eventTypes=ACCOUNTS_CREATED,ACCOUNTS_UPDATED&start=2024-01-01T00:00:00&end=2024-12-31T23:59:59"

# Todos os eventos de auditoria (√∫ltimos)
curl http://localhost:8085/api/audit/events
```

### 5. Health Checks e Monitoramento

```bash
# Verificar sa√∫de de todos os servi√ßos
curl http://localhost:8081/actuator/health  # Account Service
curl http://localhost:8082/actuator/health  # Transfer Service
curl http://localhost:8087/actuator/health  # Validation Service
curl http://localhost:8086/actuator/health  # Notification Service
curl http://localhost:8085/actuator/health  # Audit Service

# M√©tricas detalhadas
curl http://localhost:8081/actuator/metrics
curl http://localhost:8081/actuator/info
```

### 6. Teste Automatizado Completo

```bash
# Use os scripts inclu√≠dos para teste completo
./scripts/test-audit-cdc.sh      # Teste CDC completo
./scripts/test-transfer.sh       # Teste de transfer√™ncia
make test-cdc-data              # Teste com dados espec√≠ficos
make -f Makefile.dev dev-test-flow  # Teste de desenvolvimento
```

## üèõÔ∏è Arquitetura T√©cnica

### Fluxo de Transfer√™ncia Detalhado

```mermaid
sequenceDiagram
    participant Client
    participant Transfer as Transfer Service
    participant Temporal as Temporal Workflow
    participant Validation as Validation Service
    participant Account as Account Service
    participant Notification as Notification Service
    participant Audit as Audit Service
    participant Kafka
    participant CDC as Debezium CDC

    Client->>Transfer: POST /transfers
    Transfer->>Temporal: Start MoneyTransferWorkflow
    
    Note over Temporal: Saga Pattern Implementation
    Temporal->>Validation: validateTransfer()
    Validation->>Account: Check account existence
    Validation-->>Temporal: ValidationResult
    
    alt Validation Success
        Temporal->>Account: debitAccount(source)
        Account->>Account: Update balance
        Account-->>Temporal: DebitResult
        
        alt Debit Success
            Temporal->>Account: creditAccount(destination)
            Account->>Account: Update balance
            Account-->>Temporal: CreditResult
            
            Temporal->>Notification: sendNotification(SUCCESS)
            Notification->>Kafka: Publish notification event
        else Debit Failed
            Temporal->>Notification: sendNotification(FAILED)
        end
    else Validation Failed
        Temporal->>Notification: sendNotification(VALIDATION_FAILED)
    end
    
    Note over CDC,Audit: Parallel CDC Process
    Account->>CDC: Database changes (WAL)
    CDC->>Kafka: banking.public.accounts topic
    CDC->>Kafka: banking.public.transfers topic
    Kafka->>Audit: Consume CDC events
    Audit->>Audit: Store audit trail
    
    Transfer-->>Client: TransferInitiationResponse
```

### Arquitetura de Change Data Capture (CDC)

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    WAL/Logical     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ PostgreSQL      ‚îÇ    Replication     ‚îÇ Debezium        ‚îÇ
‚îÇ (banking_demo)  ‚îÇ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∂‚îÇ Connect         ‚îÇ
‚îÇ                 ‚îÇ                    ‚îÇ                 ‚îÇ
‚îÇ ‚Ä¢ accounts      ‚îÇ                    ‚îÇ ‚Ä¢ PostgreSQL    ‚îÇ
‚îÇ ‚Ä¢ transfers     ‚îÇ                    ‚îÇ   Connector     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                    ‚îÇ ‚Ä¢ JSON Format   ‚îÇ
                                       ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                                                ‚îÇ
                                                ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Audit Service   ‚îÇ‚óÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÇ Kafka Topics    ‚îÇ
‚îÇ                 ‚îÇ   Kafka Consumer   ‚îÇ                 ‚îÇ
‚îÇ ‚Ä¢ Event         ‚îÇ                    ‚îÇ ‚Ä¢ banking.      ‚îÇ
‚îÇ   Processing    ‚îÇ                    ‚îÇ   public.       ‚îÇ
‚îÇ ‚Ä¢ JSONB Storage ‚îÇ                    ‚îÇ   accounts      ‚îÇ
‚îÇ ‚Ä¢ REST API      ‚îÇ                    ‚îÇ ‚Ä¢ banking.      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                    ‚îÇ   public.       ‚îÇ
         ‚îÇ                             ‚îÇ   transfers     ‚îÇ
         ‚ñº                             ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ PostgreSQL      ‚îÇ
‚îÇ (audit_db)      ‚îÇ
‚îÇ                 ‚îÇ
‚îÇ ‚Ä¢ audit_events  ‚îÇ
‚îÇ   (JSONB)       ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### Padr√µes Arquiteturais Implementados

#### 1. **Saga Pattern (Orquestrada)**
- **Coordenador**: Temporal Workflow
- **Compensa√ß√£o**: Rollback autom√°tico em caso de falha
- **Estado**: Persistido no Temporal Server
- **Retry**: Configur√°vel por atividade

#### 2. **Event Sourcing via CDC**
- **Captura**: Debezium monitora WAL do PostgreSQL
- **Eventos**: Todas as mudan√ßas s√£o capturadas
- **Auditoria**: Trilha completa e imut√°vel
- **Replay**: Poss√≠vel reconstruir estado

#### 3. **CQRS (Command Query Responsibility Segregation)**
- **Commands**: Transfer Service (escrita)
- **Queries**: Audit Service (leitura)
- **Separa√ß√£o**: Bancos diferentes para opera√ß√£o e auditoria

#### 4. **Circuit Breaker & Retry**
- **Temporal**: Retry autom√°tico configur√°vel
- **Timeout**: Por atividade
- **Fallback**: Compensa√ß√£o em caso de falha

## üõ†Ô∏è Stack Tecnol√≥gico

### Core Technologies
- **Java 21** - Linguagem principal com features modernas
- **Spring Boot 3.2.3** - Framework de aplica√ß√£o e microservi√ßos
- **Temporal.io 1.24.1** - Orquestra√ß√£o de workflows distribu√≠dos
- **PostgreSQL 15** - Banco de dados relacional com suporte a JSONB
- **Apache Kafka 7.4.0** - Message streaming e event sourcing
- **Debezium 2.5.0.Final** - Change Data Capture em tempo real

### Infrastructure & DevOps
- **Docker & Docker Compose** - Containeriza√ß√£o e orquestra√ß√£o local
- **OpenSearch 2.5.0** - Backend de persist√™ncia para Temporal (substitui Elasticsearch)
- **Maven** - Gerenciamento de depend√™ncias e build
- **Make** - Automa√ß√£o de tarefas e scripts

### Spring Ecosystem
- **Spring Data JPA** - Persist√™ncia e mapeamento objeto-relacional
- **Spring Kafka** - Integra√ß√£o com Apache Kafka
- **Spring Cloud OpenFeign** - Comunica√ß√£o entre microservi√ßos
- **Spring Boot Actuator** - Monitoramento e m√©tricas

### Development & Testing
- **Lombok** - Redu√ß√£o de boilerplate code
- **TestContainers 1.19.6** - Testes de integra√ß√£o com containers
- **Temporal Testing SDK** - Testes de workflows
- **JUnit 5** - Framework de testes unit√°rios

### Observability
- **Spring Boot Actuator** - Health checks e m√©tricas
- **Temporal UI** - Dashboard de workflows
- **Kafka UI** - Interface para monitoramento de t√≥picos
- **Logs estruturados** - Para debug e monitoramento

### Database Features
- **PostgreSQL WAL** - Write-Ahead Logging para CDC
- **Logical Replication** - Captura de mudan√ßas em tempo real
- **JSONB** - Armazenamento eficiente de eventos de auditoria
- **Publica√ß√µes e Slots** - Configura√ß√£o CDC otimizada

## üß™ Estrat√©gia de Testes

### Testes Unit√°rios

```bash
# Todos os testes unit√°rios
./mvnw test

# Testes de um m√≥dulo espec√≠fico
./mvnw test -pl account-service
./mvnw test -pl transfer-service

# Testes com cobertura
./mvnw test jacoco:report
```

### Testes de Integra√ß√£o

```bash
# Teste completo do fluxo CDC
./scripts/test-audit-cdc.sh

# Teste de transfer√™ncia end-to-end
./scripts/test-transfer.sh

# Testes automatizados via Makefile
make test-all              # Todos os testes
make test-cdc              # CDC espec√≠fico
make test-cdc-data         # Dados espec√≠ficos
make -f Makefile.dev dev-test-flow  # Fluxo completo
```

### Testes de Workflow Temporal

```bash
# Testes espec√≠ficos de workflow
./mvnw test -Dtest=MoneyTransferWorkflowTest
./mvnw test -Dtest=*WorkflowTest

# Testes com Temporal Testing SDK
./mvnw test -pl transfer-service -Dtest=*TemporalTest
```

### Cen√°rios de Teste Cobertos

#### ‚úÖ Fluxos Principais
- **Transfer√™ncias bem-sucedidas** - Fluxo completo sem erros
- **Cria√ß√£o de contas** - Valida√ß√£o de dados e persist√™ncia
- **Consultas de saldo** - Opera√ß√µes de leitura

#### ‚úÖ Cen√°rios de Erro
- **Falhas de valida√ß√£o** - Dados inv√°lidos, regras de neg√≥cio
- **Saldo insuficiente** - Valida√ß√£o de fundos dispon√≠veis
- **Contas inexistentes** - Tratamento de entidades n√£o encontradas
- **Falhas de rede** - Timeout e indisponibilidade de servi√ßos

#### ‚úÖ Padr√µes Distribu√≠dos
- **Compensa√ß√£o de transa√ß√µes** - Rollback via Saga Pattern
- **Retry autom√°tico** - Recupera√ß√£o de falhas tempor√°rias
- **Idempot√™ncia** - Opera√ß√µes seguras para retry
- **Consist√™ncia eventual** - Sincroniza√ß√£o entre servi√ßos

#### ‚úÖ Auditoria e CDC
- **Captura de eventos** - Todas as mudan√ßas s√£o registradas
- **Integridade de dados** - Valida√ß√£o de eventos CDC
- **Rastreabilidade** - Trilha completa de opera√ß√µes
- **Performance CDC** - Lat√™ncia e throughput

### Testes de Performance

```bash
# Teste de carga b√°sico (requer ferramentas adicionais)
# curl -X POST http://localhost:8082/api/transfers (em loop)

# Monitoramento durante testes
make debug-all
make -f Makefile.dev dev-debug-kafka
```

### Testes de Resili√™ncia

```bash
# Simular falhas de servi√ßo
docker stop banking-postgres
make debug-all  # Verificar comportamento

# Simular falhas de rede
# (usar ferramentas como toxiproxy ou chaos engineering)
```

## üîç Monitoramento e Observabilidade

### Dashboards Web

| Interface | URL | Descri√ß√£o | Funcionalidades |
|-----------|-----|-----------|-----------------|
| **Temporal UI** | http://localhost:8088 | Dashboard de workflows | Execu√ß√µes, hist√≥rico, retry, debug |
| **Kafka UI** | http://localhost:8090 | Interface do Kafka | T√≥picos, mensagens, consumers, lag |
| **Debezium API** | http://localhost:8083 | API do Debezium Connect | Status conectores, configura√ß√£o, tasks |

### Endpoints de Monitoramento

```bash
# Health Checks detalhados
curl http://localhost:8081/actuator/health | jq .  # Account Service
curl http://localhost:8082/actuator/health | jq .  # Transfer Service
curl http://localhost:8085/actuator/health | jq .  # Audit Service
curl http://localhost:8086/actuator/health | jq .  # Notification Service
curl http://localhost:8087/actuator/health | jq .  # Validation Service

# M√©tricas espec√≠ficas
curl http://localhost:8081/actuator/metrics/jvm.memory.used
curl http://localhost:8082/actuator/metrics/temporal.workflow.completed
curl http://localhost:8085/actuator/metrics/kafka.consumer.records.consumed.total

# Informa√ß√µes da aplica√ß√£o
curl http://localhost:8081/actuator/info | jq .
```

### Logs Estruturados

```bash
# Logs da infraestrutura
docker logs banking-postgres           # PostgreSQL principal
docker logs banking-audit-postgres     # PostgreSQL auditoria
docker logs banking-kafka             # Kafka broker
docker logs banking-debezium-connect  # CDC connector
docker logs banking-temporal          # Temporal server

# Logs dos microservi√ßos (quando usando dev-start)
tail -f logs/account-service.log      # Account Service
tail -f logs/transfer-service.log     # Transfer Service
tail -f logs/audit-service.log        # Audit Service
tail -f logs/notification-service.log # Notification Service
tail -f logs/validation-service.log   # Validation Service

# Todos os logs em tempo real
make -f Makefile.dev dev-tail-logs
```

### Comandos de Diagn√≥stico

```bash
# Diagn√≥stico completo automatizado
make debug-all

# Diagn√≥sticos espec√≠ficos
make debug-cdc          # Status CDC detalhado
make debug-temporal     # Workflows ativos
make debug-services     # Status microservi√ßos
make debug-kafka-live   # Monitor Kafka tempo real

# Verifica√ß√£o de sa√∫de para desenvolvimento
make -f Makefile.dev dev-health-check
make -f Makefile.dev dev-check-errors
```

### M√©tricas Importantes

#### Temporal Workflows
- **Execu√ß√µes ativas**: Workflows em andamento
- **Taxa de sucesso**: Percentual de workflows completados
- **Tempo m√©dio**: Dura√ß√£o das transfer√™ncias
- **Retry count**: N√∫mero de tentativas

#### Kafka & CDC
- **Lag do consumer**: Atraso no processamento de eventos
- **Throughput**: Mensagens por segundo
- **Offset position**: Posi√ß√£o atual do consumer
- **Connector status**: Estado dos conectores Debezium

#### Microservi√ßos
- **Response time**: Tempo de resposta das APIs
- **Error rate**: Taxa de erros HTTP
- **JVM metrics**: Mem√≥ria, GC, threads
- **Database connections**: Pool de conex√µes

### Alertas e Troubleshooting

```bash
# Verificar problemas comuns
make -f Makefile.dev dev-check-errors  # Erros nos logs
make check-orphans                     # Containers √≥rf√£os
make debug-cdc                         # Problemas CDC

# Scripts de diagn√≥stico espec√≠ficos
./scripts/diagnose-cdc.sh             # Diagn√≥stico CDC visual
./scripts/diagnose-temporal.sh        # Diagn√≥stico Temporal
```

## üö® Troubleshooting

### Problemas Comuns e Solu√ß√µes

#### üîó CDC n√£o est√° funcionando
```bash
# 1. Verificar status do conector
curl http://localhost:8083/connectors/banking-connector/status | jq .

# 2. Verificar configura√ß√£o PostgreSQL
docker exec banking-postgres psql -U postgres -d banking_demo -c "
SELECT * FROM pg_publication WHERE pubname = 'dbz_publication';
SELECT slot_name, plugin, slot_type, database, active FROM pg_replication_slots;"

# 3. Reset completo do CDC
make reset-cdc

# 4. Diagn√≥stico visual
make debug-cdc
./scripts/diagnose-cdc.sh
```

#### üîÑ Loop infinito de deserializa√ß√£o no audit-service
```bash
# 1. Verificar formato das mensagens Kafka
docker exec banking-kafka kafka-console-consumer \
  --bootstrap-server localhost:9092 \
  --topic banking.public.accounts \
  --from-beginning --max-messages 1

# 2. Reset do consumer
make reset-audit-consumer

# 3. Corrigir tabela de auditoria
make fix-audit-db

# 4. Recompilar e reiniciar
make build-service SERVICE=audit-service
make -f Makefile.dev dev-restart SERVICE=audit-service
```

#### üóÑÔ∏è Erro de tipo JSONB no banco de dados
```bash
# 1. Verificar estrutura da tabela
docker exec banking-audit-postgres psql -U postgres -d audit_db -c "\d audit_events"

# 2. Recriar tabela (Hibernate criar√° automaticamente)
make fix-audit-db

# 3. Verificar logs do audit-service
make -f Makefile.dev dev-logs SERVICE=audit-service

# 4. Teste manual de inser√ß√£o JSONB
docker exec banking-audit-postgres psql -U postgres -d audit_db -c "
INSERT INTO audit_events (event_type, entity_type, entity_id, event_data, timestamp) 
VALUES ('TEST', 'accounts', 'TEST123', '{\"test\": \"data\"}'::jsonb, NOW());"
```

#### üåê Servi√ßos n√£o conseguem se conectar
```bash
# 1. Verificar rede Docker
docker network ls | grep banking
docker network inspect banking-network

# 2. Verificar containers ativos
docker ps --format "table {{.Names}}\t{{.Status}}" | grep banking

# 3. Reiniciar infraestrutura completa
make restart-all

# 4. Verificar conectividade entre servi√ßos
docker exec banking-postgres pg_isready -U postgres
docker exec banking-kafka kafka-topics --bootstrap-server localhost:9092 --list
```

#### ‚ö° Temporal workflows n√£o executam
```bash
# 1. Verificar Temporal Server
curl http://localhost:7233/api/v1/namespaces | jq .

# 2. Verificar workflows ativos
curl "http://localhost:7233/api/v1/namespaces/default/workflows" | jq .

# 3. Verificar logs do Temporal
docker logs banking-temporal | tail -50

# 4. Reset workflows se necess√°rio
make reset-temporal

# 5. Verificar configura√ß√£o do transfer-service
make -f Makefile.dev dev-logs SERVICE=transfer-service | grep -i temporal
```

#### üöÄ Microservi√ßos n√£o iniciam
```bash
# 1. Verificar se a compila√ß√£o foi bem-sucedida
make build-all

# 2. Verificar depend√™ncias (PostgreSQL deve estar rodando)
make check-infra

# 3. Verificar logs de inicializa√ß√£o
make -f Makefile.dev dev-logs SERVICE=account-service

# 4. Verificar portas em uso
netstat -tulpn | grep -E ":(8081|8082|8085|8086|8087)"

# 5. Iniciar servi√ßos individualmente para debug
java -jar account-service/target/account-service-1.0-SNAPSHOT.jar
```

### Scripts de Diagn√≥stico Avan√ßado

```bash
# Diagn√≥stico completo visual
./scripts/diagnose-cdc.sh

# Verifica√ß√£o de sa√∫de completa
make -f Makefile.dev dev-health-check

# Procurar erros espec√≠ficos
make -f Makefile.dev dev-check-errors

# Monitoramento em tempo real
make debug-kafka-live  # Kafka messages
make -f Makefile.dev dev-tail-logs  # All service logs
```

### Comandos de Recupera√ß√£o R√°pida

```bash
# Reset completo do ambiente (cuidado!)
make force-clean
make restart-all

# Reset apenas CDC
make reset-cdc

# Reset apenas dados de teste
make -f Makefile.dev dev-reset-data

# Reinicializa√ß√£o completa para desenvolvimento
make -f Makefile.dev dev-restart-all
```

### Verifica√ß√µes Manuais Avan√ßadas

```bash
# Verificar configura√ß√£o PostgreSQL WAL
docker exec banking-postgres psql -U postgres -d banking_demo -c "
SHOW wal_level;
SHOW max_replication_slots;
SHOW max_wal_senders;"

# Verificar t√≥picos Kafka e mensagens
docker exec banking-kafka kafka-topics --bootstrap-server localhost:9092 --describe --topic banking.public.accounts

# Verificar consumer groups
docker exec banking-kafka kafka-consumer-groups --bootstrap-server localhost:9092 --list
docker exec banking-kafka kafka-consumer-groups --bootstrap-server localhost:9092 --describe --group audit-service

# Verificar dados nas tabelas
docker exec banking-postgres psql -U postgres -d banking_demo -c "SELECT COUNT(*) FROM accounts;"
docker exec banking-audit-postgres psql -U postgres -d audit_db -c "SELECT COUNT(*) FROM audit_events;"
```

## üéØ Funcionalidades Principais

### üí∞ Sistema de Contas
- **Cria√ß√£o de contas** com valida√ß√£o de dados
- **Consulta de saldo** em tempo real
- **Hist√≥rico de transa√ß√µes** por conta
- **Suporte a m√∫ltiplas moedas** (BRL, USD, EUR)
- **Valida√ß√£o de integridade** de dados

### üîÑ Sistema de Transfer√™ncias
- **Transfer√™ncias seguras** entre contas
- **Valida√ß√£o de fundos** antes da execu√ß√£o
- **Saga Pattern** para consist√™ncia distribu√≠da
- **Retry autom√°tico** em caso de falhas tempor√°rias
- **Compensa√ß√£o autom√°tica** em caso de erro
- **Rastreamento completo** via workflow ID

### üîç Sistema de Auditoria
- **Trilha completa** de todas as opera√ß√µes
- **Captura em tempo real** via CDC
- **Armazenamento imut√°vel** de eventos
- **API de consulta** flex√≠vel por per√≠odo/tipo
- **Rastreabilidade** de mudan√ßas de estado

### ‚ö° Orquestra√ß√£o com Temporal
- **Workflows dur√°veis** que sobrevivem a falhas
- **Estado persistente** autom√°tico
- **Retry configur√°vel** por atividade
- **Timeout management** inteligente
- **Visibilidade completa** via UI

### üìä Monitoramento e Observabilidade
- **Health checks** detalhados
- **M√©tricas de performance** via Actuator
- **Logs estruturados** para debug
- **Dashboards visuais** para Kafka e Temporal
- **Diagn√≥stico automatizado** via scripts

## üöÄ Casos de Uso Demonstrados

### 1. Transfer√™ncia Banc√°ria Simples
```bash
# Criar contas
curl -X POST http://localhost:8081/api/accounts -H "Content-Type: application/json" \
  -d '{"accountNumber": "001", "ownerName": "Alice", "balance": 1000.00, "currency": "BRL"}'

curl -X POST http://localhost:8081/api/accounts -H "Content-Type: application/json" \
  -d '{"accountNumber": "002", "ownerName": "Bob", "balance": 500.00, "currency": "BRL"}'

# Executar transfer√™ncia
curl -X POST http://localhost:8082/api/transfers -H "Content-Type: application/json" \
  -d '{"sourceAccountNumber": "001", "destinationAccountNumber": "002", "amount": 100.00, "currency": "BRL"}'
```

### 2. Auditoria e Rastreabilidade
```bash
# Consultar trilha de auditoria
curl http://localhost:8085/api/audit/accounts/001

# Buscar eventos por per√≠odo
curl "http://localhost:8085/api/audit/search?entityType=accounts&start=2024-01-01T00:00:00&end=2024-12-31T23:59:59"
```

### 3. Monitoramento de Workflows
- Acesse http://localhost:8088 para ver workflows em execu√ß√£o
- Monitore retry autom√°tico e compensa√ß√£o
- Visualize hist√≥rico completo de execu√ß√µes

### 4. An√°lise de Eventos CDC
- Acesse http://localhost:8090 para ver mensagens Kafka
- Monitore t√≥picos `banking.public.accounts` e `banking.public.transfers`
- Observe lat√™ncia entre mudan√ßa e auditoria

## ü§ù Contribui√ß√£o

### Como Contribuir

1. **Fork** o projeto
2. **Clone** seu fork: `git clone <your-fork-url>`
3. **Crie uma branch** para sua feature: `git checkout -b feature/AmazingFeature`
4. **Configure o ambiente**: `make setup`
5. **Desenvolva** sua funcionalidade
6. **Teste** suas mudan√ßas: `make test-all`
7. **Commit** suas mudan√ßas: `git commit -m 'Add some AmazingFeature'`
8. **Push** para a branch: `git push origin feature/AmazingFeature`
9. **Abra um Pull Request**

### Padr√µes de Desenvolvimento

#### Estrutura de Commits
```
feat: adiciona nova funcionalidade de valida√ß√£o
fix: corrige problema de deserializa√ß√£o CDC
docs: atualiza documenta√ß√£o da API
test: adiciona testes para transfer service
refactor: melhora estrutura do audit service
```

#### Testes Obrigat√≥rios
- **Testes unit√°rios** para nova funcionalidade
- **Testes de integra√ß√£o** se aplic√°vel
- **Verifica√ß√£o CDC** se mudan√ßas no modelo
- **Teste end-to-end** para fluxos principais

#### Code Review Checklist
- [ ] C√≥digo segue padr√µes do projeto
- [ ] Testes passam: `make test-all`
- [ ] Documenta√ß√£o atualizada
- [ ] CDC funciona: `make test-cdc`
- [ ] Sem quebras: `make debug-all`

## üìà Performance e Escalabilidade

### M√©tricas de Performance Atuais
- **Lat√™ncia de transfer√™ncia**: ~200-500ms (end-to-end)
- **Throughput CDC**: ~1000 eventos/segundo
- **Lat√™ncia de auditoria**: ~50-100ms (ap√≥s CDC)
- **Temporal workflows**: Suporte a milhares de execu√ß√µes simult√¢neas

### Otimiza√ß√µes Implementadas
- **Connection pooling** para PostgreSQL
- **Batch processing** no audit-service
- **√çndices otimizados** para consultas de auditoria
- **Kafka partitioning** para paraleliza√ß√£o
- **Temporal worker scaling** configur√°vel

### Limites Conhecidos
- **Single-node Kafka**: Para produ√ß√£o, usar cluster
- **PostgreSQL √∫nico**: Considerar read replicas
- **Sem cache distribu√≠do**: Redis/Hazelcast para alta escala
- **Monitoramento b√°sico**: APM profissional recomendado

## üîÆ Roadmap e Pr√≥ximos Passos

### üéØ Vers√£o 2.0 (Planejada)
- [ ] **Autentica√ß√£o e Autoriza√ß√£o** (OAuth2/JWT)
- [ ] **Rate Limiting** por cliente
- [ ] **Cache distribu√≠do** (Redis)
- [ ] **M√©tricas avan√ßadas** (Prometheus/Grafana)
- [ ] **Testes de carga** automatizados

### üöÄ Melhorias de Produ√ß√£o
- [ ] **Kubernetes deployment** (Helm charts)
- [ ] **CI/CD pipeline** completo
- [ ] **Backup automatizado** dos bancos
- [ ] **Disaster recovery** procedures
- [ ] **Security scanning** automatizado

### üîß Melhorias T√©cnicas
- [ ] **Event sourcing completo** (al√©m do CDC)
- [ ] **CQRS avan√ßado** com proje√ß√µes
- [ ] **Distributed tracing** (Jaeger/Zipkin)
- [ ] **Schema evolution** para Kafka
- [ ] **Multi-tenancy** support

### üìö Documenta√ß√£o
- [ ] **API documentation** (OpenAPI/Swagger)
- [ ] **Architecture Decision Records** (ADRs)
- [ ] **Runbooks** operacionais
- [ ] **Performance benchmarks**
- [ ] **Security guidelines**

## üìö Recursos Adicionais

### Documenta√ß√£o T√©cnica
- [MAKEFILE_GUIDE.md](MAKEFILE_GUIDE.md) - Guia completo dos comandos Make
- [CHANGELOG.md](CHANGELOG.md) - Hist√≥rico de mudan√ßas
- [CONTRIBUTING.md](CONTRIBUTING.md) - Guia de contribui√ß√£o
- [request.http](request.http) - Exemplos de API

### Scripts √öteis
- `scripts/diagnose-cdc.sh` - Diagn√≥stico visual do CDC
- `scripts/test-audit-cdc.sh` - Teste completo do sistema
- `scripts/setup/start-banking-demo.sh` - Inicializa√ß√£o automatizada

### Refer√™ncias Externas
- [Temporal.io Documentation](https://docs.temporal.io/)
- [Debezium Documentation](https://debezium.io/documentation/)
- [Spring Boot Reference](https://docs.spring.io/spring-boot/docs/current/reference/html/)
- [Apache Kafka Documentation](https://kafka.apache.org/documentation/)

## üìÑ Licen√ßa

Este projeto est√° sob a licen√ßa MIT. Veja o arquivo `LICENSE` para mais detalhes.

## üÜò Suporte

### Para D√∫vidas e Problemas
1. **Consulte primeiro**: README.md e MAKEFILE_GUIDE.md
2. **Execute diagn√≥stico**: `make debug-all`
3. **Verifique logs**: `make -f Makefile.dev dev-check-errors`
4. **Abra uma issue** no GitHub com:
   - Descri√ß√£o do problema
   - Logs relevantes
   - Passos para reproduzir
   - Output do `make debug-all`

### Recursos de Ajuda
- **Issues do GitHub**: Para bugs e feature requests
- **Documenta√ß√£o oficial**: Links nas refer√™ncias acima
- **Scripts de diagn√≥stico**: Inclu√≠dos no projeto
- **Logs detalhados**: Via Makefile.dev

### Comunidade
- Contribui√ß√µes s√£o bem-vindas!
- Siga os padr√µes de contribui√ß√£o
- Participe das discuss√µes via issues
- Compartilhe casos de uso interessantes

---

**Desenvolvido com ‚ù§Ô∏è usando Temporal.io, Spring Boot e tecnologias modernas de microservi√ßos.**